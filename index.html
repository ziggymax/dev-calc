<!DOCTYPE html>
<html lang="en" data-theme="medium">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Programmer's Calculator</title>
    <style>
        /* --- THEME DEFINITIONS --- */
        
        /* 1. DARK THEME */
        :root {
            --bg-color: #e8e8e8; 
            --panel-color: #1e1e1e;
            --text-color: #e0e0e0; 
            --text-muted: #aaaaaa; 
            --accent-color: #3794ff;
            --input-bg: #2c2c2c;
            --key-bg: #333;
            --key-bg-hover: #444;
            --key-disabled: #262626;
            --text-disabled: #444;
            --error-bg: #5a2222;
            --ovf-color: #ff5555;
            --status-color: #4dff4d; 
            --status-sub-color: #aaffaa;
            --bit-op-color: #00bfa5; 
            --hint-color: #5555ff;
            --btn-op-bg: #282828;
        }

        /* 2. MEDIUM THEME */
        [data-theme="medium"] {
            --bg-color: #aab7c4;
            --panel-color: #2b3e50; 
            --text-color: #ffffff; 
            --text-muted: #b0c0d0; 
            --accent-color: #58a6a6; 
            --input-bg: #3c4f5e;
            --key-bg: #4b6375;
            --key-bg-hover: #5a768a;
            --key-disabled: #22303d;
            --text-disabled: #354652; 
            --error-bg: #633333;
            --ovf-color: #ff8888;
            --status-color: #ffcc66; 
            --status-sub-color: #ffe0a3;
            --bit-op-color: #8fa1b3;
            /* UPDATED: Lighter blue for better contrast against dark slate panel */
            --hint-color: #82b1ff; 
            --btn-op-bg: #22303d;
        }

        /* 3. LIGHT THEME */
        [data-theme="light"] {
            --bg-color: #f2efe9; 
            --panel-color: #faf9f6; 
            --text-color: #3e3b38; 
            --text-muted: #555555; 
            --accent-color: #6200ea; 
            --input-bg: #f8f6f2; 
            --key-bg: #e6e2dd; 
            --key-bg-hover: #d9d5cf;
            --key-disabled: #f4f4f4;
            --text-disabled: #ccc;
            --error-bg: #ffcccc;
            --ovf-color: #d50000; 
            --status-color: #008b00; 
            --status-sub-color: #555;
            --bit-op-color: #ff6d00; 
            --hint-color: #6200ea;
            --btn-op-bg: #f0ede9;
        }

        /* --- GLOBAL STYLES --- */

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 0; 
            transition: background-color 0.3s;
        }

        .calculator {
            background-color: var(--panel-color);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3); 
            width: 100%;
            max-width: 950px; 
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px;
            position: relative;
            transition: background-color 0.3s;
        }

        .calc-screen {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .calc-pad {
            flex: 1;
        }

        h2 { 
            text-align: center; 
            margin: 0 0 2px 0; 
            font-weight: 300; 
            font-size: 1.5rem; 
            color: var(--text-muted); 
        }

        .zoom-hint {
            text-align: center;
            font-size: 0.85rem;
            color: var(--hint-color); 
            margin-bottom: 10px;
            font-weight: 500;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 5px;
        }
        
        .sub-controls {
            display: flex;
            justify-content: space-between; 
            align-items: center;
            gap: 10px; 
            margin-bottom: 5px;
            padding: 0 2px;
        }
        
        .checks-container {
            display: flex;
            gap: 20px;
        }

        .cb-label {
            font-size: 0.9rem;
            color: var(--text-color); 
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
        }
        
        .cb-label input {
            width: auto; 
            margin: 0;
            cursor: pointer;
            accent-color: var(--accent-color);
            transform: scale(1.1); 
        }

        /* Info Button Style */
        .btn-info {
            background: none;
            border: 1px solid var(--text-muted);
            color: var(--text-muted);
            border-radius: 4px;
            padding: 4px 10px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-info:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        .control-group { flex: 1; }
        
        select {
            width: 100%;
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid #555;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.9rem;
            outline: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        [data-theme="light"] select { border-color: #ccc; }

        .display-group {
            position: relative;
            display: flex;
            align-items: center;
        }

        .label-tag {
            position: absolute;
            left: 10px;
            color: var(--accent-color);
            font-family: var(--font-mono);
            font-weight: bold;
            font-size: 0.8rem;
            pointer-events: none;
        }

        input[type="text"] {
            width: 100%;
            background-color: var(--input-bg);
            border: 1px solid #555;
            color: var(--text-color);
            padding: 12px 10px 12px 50px; 
            font-family: var(--font-mono);
            font-size: 1.0rem; 
            border-radius: 6px;
            box-sizing: border-box;
            transition: background-color 0.1s, border-color 0.2s;
        }
        
        [data-theme="light"] input[type="text"] { border-color: #ccc; }

        input:focus, input.active-field {
            border-color: var(--accent-color) !important;
            background-color: var(--input-bg); 
            outline: none;
            box-shadow: 0 0 0 1px var(--accent-color);
        }

        .input-error {
            background-color: var(--error-bg) !important;
            border-color: var(--ovf-color) !important;
        }
        
        .error-text {
            color: var(--ovf-color) !important;
            font-weight: bold;
        }

        .status-bar {
            height: 35px; 
            min-height: 35px;
            font-size: 1.2rem; 
            text-align: right;
            color: var(--status-color); 
            font-family: var(--font-mono);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex; 
            align-items: center;
            justify-content: flex-end;
            padding-bottom: 2px; 
            text-shadow: 0 0 5px rgba(77, 255, 77, 0.1); 
        }
        
        .status-bar sub {
            font-size: 0.75em; 
            vertical-align: baseline; 
            position: relative;
            bottom: -0.3em; 
            margin-left: 2px;
            margin-right: 6px;
            color: var(--status-sub-color); 
            font-weight: normal;
            opacity: 0.9;
        }

        .keypad {
            display: grid;
            grid-template-columns: repeat(5, 1fr); 
            gap: 8px;
            height: 100%; 
        }

        button {
            padding: 15px 0;
            font-size: 1.1rem; 
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.1s;
            font-family: var(--font-mono);
            background-color: var(--key-bg);
            color: var(--text-color); 
            user-select: none;
            touch-action: manipulation; 
            display: flex;
            align-items: center;
            justify-content: center;
        }

        button:active { transform: translateY(2px); }

        @media (hover: hover) {
            button:hover { background-color: var(--key-bg-hover); transform: translateY(-1px); }
            button:active { transform: translateY(1px); }
        }

        .btn-entry { font-weight: bold; color: var(--text-color); }
        .btn-op { background-color: var(--btn-op-bg); color: var(--accent-color); font-weight: bold; font-size: 1.3rem; }
        .btn-bit { background-color: var(--btn-op-bg); color: var(--bit-op-color); font-weight: bold; font-size: 1rem; }
        .btn-action { background-color: var(--accent-color); color: white; } 
        .btn-action:hover { opacity: 0.9; }
        .btn-clear { background-color: #a33; color: white; }
        .btn-clear:hover { background-color: #922; }

        button.disabled {
            background-color: var(--key-disabled);
            color: var(--text-disabled);
            cursor: default;
            box-shadow: none;
            transform: none;
            font-weight: normal; 
        }

        /* --- Modal Styles --- */
        .modal-overlay {
            display: none; 
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }

        .modal-content {
            background-color: var(--panel-color);
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            border: 1px solid #555;
            box-shadow: 0 10px 25px rgba(0,0,0,0.8);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        .modal-content h3 {
            margin-top: 0;
            color: var(--accent-color);
            text-align: center;
            font-weight: 400;
        }

        .prec-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 0.9rem;
        }

        .prec-table th {
            text-align: left;
            border-bottom: 1px solid #555;
            padding: 8px;
            color: var(--text-muted);
        }

        .prec-table td {
            padding: 8px;
            border-bottom: 1px solid #444; 
            color: var(--text-color);
        }
        
        [data-theme="light"] .prec-table td { border-bottom: 1px solid #ddd; }

        .prec-table td:last-child {
            font-family: var(--font-mono);
            font-weight: bold;
            text-align: right;
        }

        .btn-close-modal {
            width: 100%;
            background-color: var(--accent-color);
            color: white;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 10px;
        }
        .btn-close-modal:hover {
            opacity: 0.9;
        }

        @media (max-width: 400px) {
            .calculator {
                margin: 0;
                border-radius: 0;
                min-height: 100vh;
                padding: 15px;
            }
        }

        @media (max-height: 600px) and (orientation: landscape) {
            body { align-items: stretch; }
            .calculator {
                flex-direction: row; 
                max-width: 100%;
                margin: 0;
                min-height: 100vh;
                border-radius: 0;
                padding: 15px;
                gap: 20px;
            }
            .calc-screen { flex: 1; justify-content: center; gap: 8px; }
            .calc-pad { flex: 1.2; }
            h2 { display: none; } 
            .zoom-hint { display: none; } 
            input[type="text"] { padding: 8px 8px 8px 50px; font-size: 1rem; }
            button { padding: 0; font-size: 1rem; }
        }
    </style>
</head>
<body>

<div id="infoModal" class="modal-overlay">
    <div class="modal-content">
        <h3>Operator Info</h3>
        <p style="font-size: 0.9rem; color: var(--text-muted); text-align: center; margin-bottom: 15px;">
            Operations are evaluated in the following order (Highest to Lowest):
        </p>
        <table class="prec-table">
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Operators</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Unary (Immediate)</td>
                    <td>NOT, +/-</td>
                </tr>
                <tr>
                    <td>Multiplicative</td>
                    <td>×, ÷</td>
                </tr>
                <tr>
                    <td>Additive</td>
                    <td>+, -</td>
                </tr>
                <tr>
                    <td>Bitwise Logic</td>
                    <td>AND, OR, XOR...</td>
                </tr>
            </tbody>
        </table>
        <button class="btn-close-modal" id="btnCloseModal">Close</button>
    </div>
</div>

<div class="calculator">
    <div class="calc-screen">
        <h2>Programmer's Calculator</h2>
        <div class="zoom-hint">Use Ctrl+ Ctrl- or Ctrl-MouseScroll to adjust size</div>

        <div class="controls">
            <div class="control-group">
                <select id="themeSelect">
                    <option value="dark">Theme: Dark</option>
                    <option value="medium" selected>Theme: Medium</option>
                    <option value="light">Theme: Light</option>
                </select>
            </div>
            
            <div class="control-group">
                <select id="bitSelect">
                    <option value="64">64-bit</option>
                    <option value="32" selected>32-bit</option>
                    <option value="16">16-bit</option>
                    <option value="8">8-bit</option>
                </select>
            </div>
            <div class="control-group">
                <select id="signSelect">
                    <option value="signed">Signed</option>
                    <option value="unsigned">Unsigned</option>
                </select>
            </div>
        </div>

        <div class="sub-controls">
            <div class="checks-container">
                <label class="cb-label">
                    <input type="checkbox" id="cbGrouping"> Grouping
                </label>
                <label class="cb-label">
                    <input type="checkbox" id="cbAllBits"> Show all bits
                </label>
            </div>
            <button class="btn-info" id="btnInfo">Operator info</button>
        </div>

        <div class="display-group">
            <span class="label-tag">HEX</span>
            <input type="text" id="hexInput" placeholder="0" spellcheck="false" autocomplete="off" data-last="0" maxlength="30">
        </div>
        <div class="display-group">
            <span class="label-tag">DEC</span>
            <input type="text" id="decInput" placeholder="0" spellcheck="false" autocomplete="off" data-last="0" maxlength="30">
        </div>
        <div class="display-group">
            <span class="label-tag">BIN</span>
            <input type="text" id="binInput" placeholder="0" spellcheck="false" autocomplete="off" data-last="0" maxlength="100">
        </div>

        <div class="status-bar" id="opStatus"></div>
    </div>

    <div class="calc-pad">
        <div class="keypad">
            <button class="btn-entry" data-val="D">D</button>
            <button class="btn-entry" data-val="E">E</button>
            <button class="btn-entry" data-val="F">F</button>
            <button class="btn-clear" onclick="clearAll()">AC</button>
            <button class="btn-bit" onclick="setOp('AND')">AND</button>

            <button class="btn-entry" data-val="A">A</button>
            <button class="btn-entry" data-val="B">B</button>
            <button class="btn-entry" data-val="C">C</button>
            <button class="btn-op" onclick="backspace()">⌫</button>
            <button class="btn-bit" onclick="setOp('NAND')">NAND</button>

            <button class="btn-entry" data-val="7">7</button>
            <button class="btn-entry" data-val="8">8</button>
            <button class="btn-entry" data-val="9">9</button>
            <button class="btn-op" onclick="setOp('/')">÷</button>
            <button class="btn-bit" onclick="setOp('OR')">OR</button>

            <button class="btn-entry" data-val="4">4</button>
            <button class="btn-entry" data-val="5">5</button>
            <button class="btn-entry" data-val="6">6</button>
            <button class="btn-op" onclick="setOp('*')">×</button>
            <button class="btn-bit" onclick="setOp('NOR')">NOR</button>

            <button class="btn-entry" data-val="1">1</button>
            <button class="btn-entry" data-val="2">2</button>
            <button class="btn-entry" data-val="3">3</button>
            <button class="btn-op" id="btnMinus">-</button>
            <button class="btn-bit" onclick="setOp('XOR')">XOR</button>

            <button class="btn-entry" data-val="0">0</button>
            <button class="btn-entry" data-action="sign">+/-</button> 
            <button class="btn-action" onclick="calculate()">=</button>
            <button class="btn-op" onclick="setOp('+')">+</button>
            <button class="btn-bit" onclick="doUnary('NOT')">NOT</button>
        </div>
    </div>
</div>

<script>
    /* --- State --- */
    let expressionQueue = [];
    let currentBigInt = 0n;
    
    let isTyping = false; 
    let waitingForOperand = false;
    let activeInputId = 'decInput'; 
    let errorState = null;

    /* --- DOM --- */
    const elTheme = document.getElementById('themeSelect');
    const elBits = document.getElementById('bitSelect');
    const elSign = document.getElementById('signSelect');
    const elGrouping = document.getElementById('cbGrouping');
    const elAllBits = document.getElementById('cbAllBits');

    const elHex = document.getElementById('hexInput');
    const elDec = document.getElementById('decInput');
    const elBin = document.getElementById('binInput');
    const elStatus = document.getElementById('opStatus');
    const keys = document.querySelectorAll('.keypad button[data-val]');
    
    /* --- Modal Logic --- */
    const modal = document.getElementById('infoModal');
    const btnInfo = document.getElementById('btnInfo');
    const btnCloseModal = document.getElementById('btnCloseModal');

    btnInfo.onclick = () => { modal.style.display = 'flex'; };
    btnCloseModal.onclick = () => { modal.style.display = 'none'; };
    modal.onclick = (e) => { if(e.target === modal) modal.style.display = 'none'; };

    /* --- Helpers --- */
    const getMod = () => 1n << BigInt(elBits.value);
    const getMask = () => getMod() - 1n;
    const getSignBit = () => 1n << (BigInt(elBits.value) - 1n);

    const radixMap = { 'hexInput': 16, 'decInput': 10, 'binInput': 2 };
    const validChars = { 'hexInput': "0123456789ABCDEFabcdef", 'decInput': "0123456789-", 'binInput': "01" };
    const validators = {
        'hexInput': /[^0-9a-fA-F]/g,
        'decInput': /[^0-9\-]/g,
        'binInput': /[^0-1]/g
    };

    function formatBigInt(val) {
        if(elSign.value === 'unsigned') {
            return (val & getMask()).toString(10);
        } else {
            let masked = val & getMask();
            if ((masked & getSignBit()) !== 0n) {
                return (masked - getMod()).toString(10);
            }
            return masked.toString(10);
        }
    }

    function formatDisplayString(str, radix, isForActiveInput, forceNoPadding = false) {
        if (!str) return str;
        let res = str;

        if (elAllBits.checked && !isForActiveInput && !forceNoPadding) {
            const bits = parseInt(elBits.value);
            let targetLen = 0;
            if (radix === 2) targetLen = bits;
            if (radix === 16) targetLen = bits / 4;
            
            if (targetLen > 0) res = res.padStart(targetLen, '0');
        }

        if (elGrouping.checked && (radix === 2 || radix === 16)) {
            res = res.split('').reverse().join('')
                     .match(/.{1,4}/g)
                     .join(' ')
                     .split('').reverse().join('');
        }
        return res;
    }

    function formatForStatus(valObj) {
        if(!valObj || typeof valObj !== 'object') return "";
        const val = valObj.val;
        const r = valObj.radix;
        const mask = getMask();

        if (r === 16) {
            let rawHex = (val & mask).toString(16).toUpperCase();
            return formatDisplayString(rawHex, 16, false, true) + "<sub>H</sub>";
        } else if (r === 2) {
            let rawBin = (val & mask).toString(2);
            return formatDisplayString(rawBin, 2, false, true) + "<sub>B</sub>";
        } else {
            return formatBigInt(val) + "<sub>D</sub>";
        }
    }

    /* --- Input Guards --- */
    function safeParseBigInt(str, radix) {
        if(!str || str === '-') return 0n;
        if(radix === 16) return BigInt("0x" + str);
        if(radix === 2) return BigInt("0b" + str);
        return BigInt(str);
    }

    function flashError(el) {
        el.classList.add('input-error');
        setTimeout(() => { el.classList.remove('input-error'); }, 150);
    }

    function isInputOverflow(strVal, radix) {
        if(!strVal || strVal === '-') return false; 
        try {
            const val = safeParseBigInt(strVal, radix);
            const bits = BigInt(elBits.value);
            
            if (radix === 16 || radix === 2) {
                const max = (1n << bits) - 1n;
                return (val < 0n || val > max);
            }
            if (radix === 10) {
                if(elSign.value === 'signed') {
                    const max = (1n << (bits - 1n)) - 1n;
                    const min = -(1n << (bits - 1n));
                    return (val > max || val < min);
                } else {
                    const max = (1n << bits) - 1n;
                    return (val < 0n || val > max);
                }
            }
        } catch(e) { return true; }
        return false;
    }

    /* --- Update Logic --- */
    function updateInputs(source) {
        if(isTyping) return;
        isTyping = true;

        if (errorState) {
            let errStr = errorState === 'Div0' ? '<Div0>' : '<Ovf>';
            elHex.value = errStr; elDec.value = errStr; elBin.value = errStr;
            elHex.classList.add('error-text'); elDec.classList.add('error-text'); elBin.classList.add('error-text');
        } else {
            elHex.classList.remove('error-text'); elDec.classList.remove('error-text'); elBin.classList.remove('error-text');

            let maskedVal = currentBigInt & getMask();
            currentBigInt = maskedVal; 

            let rawHex = maskedVal.toString(16).toUpperCase();
            let rawBin = maskedVal.toString(2);
            let decStr = formatBigInt(maskedVal); 
            
            let displayHex = formatDisplayString(rawHex, 16, false);
            let displayBin = formatDisplayString(rawBin, 2, false);

            if (source !== 'hexInput') elHex.value = displayHex;
            if (source !== 'decInput') elDec.value = decStr;
            if (source !== 'binInput') elBin.value = displayBin;

            if (elHex.value === '') elHex.value = '0';
            if (elDec.value === '') elDec.value = '0';
            if (elBin.value === '') elBin.value = '0';
            
            elHex.setAttribute('data-last', elHex.value);
            elDec.setAttribute('data-last', elDec.value);
            elBin.setAttribute('data-last', elBin.value);
        }

        updateKeypadState();
        isTyping = false;
    }

    function updateStatusText(resultObj) {
        if (errorState && !resultObj) return; 

        let html = "";
        expressionQueue.forEach(item => {
            if (typeof item === 'object') {
                html += formatForStatus(item) + " ";
            } else {
                let s = item;
                if(item === '*') s = '×';
                else if(item === '/') s = '÷';
                html += s + " ";
            }
        });

        if (resultObj) {
            let errStr = "";
            if(errorState) errStr = errorState === 'Div0' ? '&lt;Div0&gt;' : '&lt;Ovf&gt;';
            let resHtml = errorState ? errStr : formatForStatus(resultObj);
            
            elStatus.innerHTML = html + "= " + resHtml;
            if(errorState) elStatus.classList.add('error-text');
            else elStatus.classList.remove('error-text');
        } else {
            if(!waitingForOperand && !errorState) {
                html += formatForStatus({ val: currentBigInt, radix: radixMap[activeInputId] });
            }
            elStatus.innerHTML = html;
            elStatus.classList.remove('error-text');
        }
    }

    function prepareForNewInput() {
        if (errorState) { clearAll(); return; }
        if (waitingForOperand) {
            elHex.value = ''; elDec.value = ''; elBin.value = '';
            elHex.setAttribute('data-last', '');
            elDec.setAttribute('data-last', '');
            elBin.setAttribute('data-last', '');
            currentBigInt = 0n;
            waitingForOperand = false;
        }
    }

    /* --- Input Handlers --- */
    function setupInput(el, radix) {
        el.addEventListener('focus', () => {
            activeInputId = el.id;
            [elHex, elDec, elBin].forEach(i => i.classList.remove('active-field'));
            el.classList.add('active-field');
            updateKeypadState();
        });
        el.addEventListener('keydown', () => prepareForNewInput());
        el.addEventListener('input', (e) => {
            if(errorState) { prepareForNewInput(); }

            let rawVal = el.value.toUpperCase().replace(validators[el.id], '').replace(/\s/g, '');
            
            if (rawVal.length > 1 && rawVal.startsWith('0') && rawVal[1] !== 'x' && rawVal[1] !== 'b') {
                rawVal = rawVal.substring(1); 
            }
            if (rawVal === '') rawVal = ''; 

            let parseStr = rawVal;
            if(radix === 16 && parseStr.startsWith('0X')) parseStr = parseStr.substring(2);
            if(radix === 2 && parseStr.startsWith('0B')) parseStr = parseStr.substring(2);

            if (parseStr !== '' && parseStr !== '-' && isInputOverflow(parseStr, radix)) {
                el.value = el.getAttribute('data-last') || '';
                flashError(el);
                return; 
            }

            if (!parseStr || parseStr === '-') {
                if (!parseStr) currentBigInt = 0n;
            } else {
                try {
                    currentBigInt = safeParseBigInt(parseStr, radix);
                } catch(err) {}
            }

            let formattedDisplay = formatDisplayString(rawVal, radix, true);
            
            const oldStart = el.selectionStart;
            
            el.value = formattedDisplay;
            el.setAttribute('data-last', el.value); 
            
            const oldLen = rawVal.length; 
            const newLen = el.value.length;
            if (oldStart !== null && document.activeElement === el) {
                if(newLen > oldLen) {
                    el.setSelectionRange(oldStart + (newLen - oldLen), oldStart + (newLen - oldLen));
                } else {
                    el.setSelectionRange(oldStart, oldStart);
                }
            }

            updateInputs(el.id); 
            updateStatusText(null); 
        });
    }

    setupInput(elHex, 16);
    setupInput(elDec, 10);
    setupInput(elBin, 2);

    function updateKeypadState() {
        const valKeys = document.querySelectorAll('.keypad button[data-val]');
        valKeys.forEach(btn => {
            const char = btn.getAttribute('data-val');
            let allowed = validChars[activeInputId].includes(char);
            
            if (char === '-') {
                const decVal = elDec.value;
                const isSignedMode = elSign.value === 'signed';
                allowed = isSignedMode && (activeInputId === 'decInput');
            }
            if (allowed) btn.classList.remove('disabled');
            else btn.classList.add('disabled');
        });
        
        // Handle Sign Button State Explicitly
        const signBtn = document.querySelector('button[data-action="sign"]');
        const isSigned = elSign.value === 'signed';
        const isDec = activeInputId === 'decInput';
        if (signBtn) {
            if (isSigned && isDec) signBtn.classList.remove('disabled');
            else signBtn.classList.add('disabled');
        }
    }

    // Attach listeners to buttons with data-val (Entries)
    const valKeys = document.querySelectorAll('.keypad button[data-val]');
    valKeys.forEach(btn => {
        btn.addEventListener('mousedown', (e) => e.preventDefault());
        
        btn.addEventListener('click', () => {
            prepareForNewInput(); 
            const char = btn.getAttribute('data-val');
            const activeEl = document.getElementById(activeInputId);
            
            let allowed = validChars[activeInputId].includes(char);
            if(!allowed) return;
            
            if(activeEl.value.length >= activeEl.maxLength && char !== '-') {
                 flashError(activeEl); return;
            }

            let currentVal = activeEl.value;
            if(currentVal === '0') currentVal = ''; 
            
            let candidate = currentVal + char;

            let cleanCandidate = candidate.replace(/\s/g, '');

            let radix = activeInputId === 'hexInput' ? 16 : activeInputId === 'binInput' ? 2 : 10;
            if (isInputOverflow(cleanCandidate, radix)) { flashError(activeEl); return; }

            activeEl.value = candidate;
            activeEl.dispatchEvent(new Event('input'));
            activeEl.focus(); 
        });
    });
    
    // Sign Button Listener
    const signBtn = document.querySelector('button[data-action="sign"]');
    if(signBtn) {
        signBtn.addEventListener('mousedown', (e) => e.preventDefault());
        signBtn.addEventListener('click', () => {
            prepareForNewInput();
            const activeEl = document.getElementById(activeInputId);
            const isSigned = elSign.value === 'signed';
            const isDec = activeInputId === 'decInput';
            
            if(isSigned && isDec) {
                let cur = activeEl.value;
                if(cur === '0' || cur === '') {
                    activeEl.value = '-';
                } else if (cur === '-') {
                    activeEl.value = '';
                } else if (cur.startsWith('-')) {
                    activeEl.value = cur.substring(1);
                } else {
                    activeEl.value = '-' + cur;
                }
                
                let checkVal = activeEl.value;
                if(checkVal !== '-' && checkVal !== '') {
                     if(isInputOverflow(checkVal, 10)) {
                         flashError(activeEl);
                         activeEl.value = cur; 
                         return;
                     }
                }
                
                activeEl.dispatchEvent(new Event('input'));
                activeEl.focus();
            }
        });
    }
    
    // Updated On-Screen Minus Button Logic (Smart Minus)
    const btnMinus = document.getElementById('btnMinus');
    if(btnMinus) {
        btnMinus.addEventListener('mousedown', (e) => e.preventDefault());
        btnMinus.addEventListener('click', () => {
            const activeEl = document.getElementById(activeInputId);
            const isDec = activeInputId === 'decInput';
            const isSigned = elSign.value === 'signed';
            const isEmptyOrZero = (activeEl.value === '' || activeEl.value === '0');
            
            if (isDec && isSigned && isEmptyOrZero) {
                // Trigger the sign toggle/unary logic
                if(signBtn && !signBtn.classList.contains('disabled')) signBtn.click();
            } else {
                // Trigger standard subtraction
                setOp('-');
            }
        });
    }
    
    const opKeys = document.querySelectorAll('.keypad button:not([data-val]):not([data-action]):not(#btnMinus)');
    opKeys.forEach(btn => {
        btn.addEventListener('mousedown', (e) => e.preventDefault());
    });

    function backspace() {
        if(errorState) { clearAll(); return; }
        prepareForNewInput();
        const activeEl = document.getElementById(activeInputId);
        let val = activeEl.value;
        if(val.length > 0) {
            activeEl.value = val.slice(0, -1);
            if(activeEl.value === '') activeEl.value = '0';
            activeEl.dispatchEvent(new Event('input'));
        }
    }

    /* --- Operations & Math Engine --- */
    function setOp(op) {
        if(errorState) return;
        
        const entry = { 
            val: currentBigInt, 
            radix: radixMap[activeInputId] 
        };

        if(waitingForOperand && expressionQueue.length > 0) {
            expressionQueue[expressionQueue.length - 1] = op;
        } else {
            expressionQueue.push(entry);
            expressionQueue.push(op);
        }
        
        waitingForOperand = true;
        updateStatusText(null);
        updateInputs('all');
    }

    function doUnary(op) {
        if(errorState) return;
        if(waitingForOperand) {
            waitingForOperand = false; 
        }

        const mask = getMask();
        if(op === 'NOT') {
            currentBigInt = (~currentBigInt) & mask;
        }
        
        updateInputs('all');
        updateStatusText(null);
    }

    function calculatePair(aObj, op, bObj) {
        let result = 0n;
        const bits = BigInt(elBits.value);
        const mod = 1n << bits;
        const signBit = 1n << (bits - 1n);

        const toReal = (val) => {
            if (elSign.value === 'unsigned') return val;
            if ((val & signBit) !== 0n) return val - mod; 
            return val;
        };

        const realA = toReal(aObj.val);
        const realB = toReal(bObj.val);
        const rawA = aObj.val;
        const rawB = bObj.val;

        if (op === '/' && realB === 0n) throw "Div0";
        
        switch (op) {
            case '+': result = realA + realB; break;
            case '-': result = realA - realB; break;
            case '*': result = realA * realB; break;
            case '/': result = realA / realB; break;
            case 'AND': result = rawA & rawB; break;
            case 'OR':  result = rawA | rawB; break;
            case 'XOR': result = rawA ^ rawB; break;
            case 'NAND': result = ~(rawA & rawB); break;
            case 'NOR':  result = ~(rawA | rawB); break;
        }

        if (['+', '-', '*', '/'].includes(op)) {
            if (elSign.value === 'unsigned') {
                const max = mod - 1n;
                if (result < 0n || result > max) throw "Ovf";
            } else {
                const max = (1n << (bits - 1n)) - 1n;
                const min = -(1n << (bits - 1n));
                if (result > max || result < min) throw "Ovf";
            }
        }

        return { 
            val: result & (mod - 1n), 
            radix: aObj.radix 
        };
    }

    function calculate() {
        if (errorState) { clearAll(); return; }
        if (expressionQueue.length === 0 && !waitingForOperand) return;

        expressionQueue.push({ 
            val: currentBigInt, 
            radix: radixMap[activeInputId] 
        });

        try {
            let tokens = [...expressionQueue];
            
            // Pass 1: * /
            for(let i=0; i<tokens.length; i++) {
                if(tokens[i] === '*' || tokens[i] === '/') {
                    let left = tokens[i-1];
                    let right = tokens[i+1];
                    let res = calculatePair(left, tokens[i], right);
                    tokens.splice(i-1, 3, res);
                    i--; 
                }
            }

            // Pass 2: + -
            for(let i=0; i<tokens.length; i++) {
                if(tokens[i] === '+' || tokens[i] === '-') {
                    let left = tokens[i-1];
                    let right = tokens[i+1];
                    let res = calculatePair(left, tokens[i], right);
                    tokens.splice(i-1, 3, res);
                    i--; 
                }
            }
            
            // Pass 3: Bitwise
            for(let i=0; i<tokens.length; i++) {
                if(['AND', 'OR', 'XOR', 'NAND', 'NOR'].includes(tokens[i])) {
                    let left = tokens[i-1];
                    let right = tokens[i+1];
                    let res = calculatePair(left, tokens[i], right);
                    tokens.splice(i-1, 3, res);
                    i--; 
                }
            }

            let finalObj = tokens[0];
            
            let resultForDisplay = {
                val: finalObj.val,
                radix: radixMap[activeInputId]
            };
            
            updateStatusText(resultForDisplay);
            
            currentBigInt = finalObj.val;
            expressionQueue = []; 
            waitingForOperand = true; 
            
            updateInputs('all');
            
        } catch(e) {
            errorState = (e === "Div0") ? 'Div0' : 'Ovf';
            updateStatusText({}); 
            updateInputs('all');
        }
    }

    function clearAll() {
        currentBigInt = 0n;
        expressionQueue = [];
        waitingForOperand = false;
        errorState = null;
        elStatus.innerHTML = ''; 
        elStatus.classList.remove('error-text');
        
        elHex.value = '0'; elDec.value = '0'; elBin.value = '0';
        elHex.setAttribute('data-last', '0');
        elDec.setAttribute('data-last', '0');
        elBin.setAttribute('data-last', '0');

        document.getElementById(activeInputId).focus();
        updateInputs('all');
    }

    // Init & Listeners
    elDec.focus();
    updateInputs('all');
    
    elBits.addEventListener('change', () => { if(errorState) clearAll(); else updateInputs('all'); });
    elSign.addEventListener('change', () => { 
        updateKeypadState(); // Ensure sign button state updates immediately
        if(errorState) clearAll(); else updateInputs('all'); 
    });
    
    elGrouping.addEventListener('change', () => { if(errorState) clearAll(); else updateInputs('all'); });
    elAllBits.addEventListener('change', () => { if(errorState) clearAll(); else updateInputs('all'); });
    
    // Theme Switcher Listener
    elTheme.addEventListener('change', (e) => {
        document.documentElement.setAttribute('data-theme', e.target.value);
    });

    // Global Key Listener
    document.addEventListener('keydown', (e) => {
        // Allow Browser Zoom (Ctrl +/-)
        if (e.ctrlKey || e.metaKey) return;

        const key = e.key;
        
        // Handle Minus Logic (Unary vs Subtraction)
        if (key === '-') {
            const activeEl = document.getElementById(activeInputId);
            const isDec = activeInputId === 'decInput';
            const isSigned = elSign.value === 'signed';
            const isEmptyOrZero = (activeEl.value === '' || activeEl.value === '0');
            
            if (isDec && isSigned && isEmptyOrZero) {
                if(signBtn && !signBtn.classList.contains('disabled')) signBtn.click();
                e.preventDefault();
                return;
            }
            
            e.preventDefault();
            setOp('-');
            return;
        }

        if (['+', '*', '/'].includes(key)) {
            e.preventDefault();
            setOp(key);
            return;
        }
        
        if (key === 'Enter' || key === '=') {
            e.preventDefault();
            calculate();
            return;
        }
        
        if (key === 'Escape') {
            e.preventDefault();
            clearAll();
            return;
        }
    });

</script>

</body>
</html>
